# Update Policy 관리 시스템 구축 및 검증 작업 지시서

## 📄 Update Policy 관리 시스템 구축 및 검증 작업 지시서

### 🎯 목표: Update Policy 관리 시스템 구현 및 검증

본 문서는 **Supabase 스키마**를 기반으로 Android 앱에 **업데이트 팝업 관리 시스템**을 구축하고, **단위 테스트**를 통해 로직의 정확성을 검증하기 위한 AI 에이전트의 작업 지침입니다.

---

### I. ☁️ Supabase 스키마 정보 **(반드시 참조)**

모든 데이터 모델(`UpdatePolicy.kt`) 및 로직 구현 시, 다음 **`update_policy` 테이블 스키마**를 **반드시 참조**하여 컬럼 이름과 데이터 타입을 일치시켜야 합니다.

SQL

```sql
create table public.update_policy (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone null default now(),
  app_id text not null,
  is_active boolean not null default true,
  target_version_code integer not null,
  is_force_update boolean not null,
  release_notes text null,
  download_url text not null default 'https://play.google.com/'::text,
  reshow_interval_hours integer not null default 24,
  max_later_count integer not null default 3,
  reshow_interval_minutes integer null,
  reshow_interval_seconds integer null,
  constraint update_policy_pkey primary key (id),
  constraint check_reshow_interval_positive check (
    (
      (
        (reshow_interval_hours is null)
        or (reshow_interval_hours >= 0)
      )
      and (
        (reshow_interval_minutes is null)
        or (reshow_interval_minutes >= 0)
      )
      and (
        (reshow_interval_seconds is null)
        or (reshow_interval_seconds >= 0)
      )
      and (max_later_count >= 0)
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_update_policy_app_id on public.update_policy using btree (app_id) TABLESPACE pg_default;

create index IF not exists idx_update_policy_active on public.update_policy using btree (is_active) TABLESPACE pg_default;

create unique INDEX IF not exists idx_update_policy_unique_active on public.update_policy using btree (app_id) TABLESPACE pg_default
where
  (is_active = true);
```

---

### II. 🛠️ 구현 단계: 업데이트 팝업 생성 및 로직 통합

### 1. 데이터 구조 정의 (Model Layer)

- 위치: data.supabase.model
- **`model`** 폴더 내에 Supabase 스키마에 맞춰 **`UpdatePolicy.kt`** 데이터 클래스를 정의할 것.
- 로컬 기록 관리를 위해 **`UpdateStats.kt`** (currentLaterCount, lastDismissedTimestamp 포함) 데이터 클래스를 **`model`** 폴더에 정의할 것.

### 2. 정책 저장소 구현 (Repository Layer)

- 위치: data.supabase.repository
- **`UpdatePolicyRepository.kt`** 파일에 Supabase에서 **`update_policy` 데이터**를 가져오는 함수를 구현할 것.

### 3. **🎨 업데이트 팝업 UI 구현**

- ui.dialogs.OptionalUpdateDialog.kt
- 위 파일에 구현됨

### 4. 핵심 로직 구현 (Manager Layer)

- 위치: data.supabase.repository
- **`PopupPolicyManager.kt`** 파일에 UpdatePolicy를 처리하는 로직을 완성할 것.
- 로직 검사 조건:
    
    a) 횟수 제한: **max_later_count**와 로컬 기록(UpdateStats)을 비교하여 노출 여부 결정.
    
    b) 쿨다운: reshow_interval_hours 등과 로컬 기록을 비교하여 쿨다운 시간 경과 여부 결정.
    
    c) 강제 업데이트: is_force_update = true 일 경우, 횟수/시간 제한을 무시하고 즉시 노출 로직을 구현할 것.
    
    d) 버전 검사: 현재 앱의 versionCode가 target_version_code보다 낮은 경우에만 노출되도록 로직을 추가할 것.
    

---

### III. 🧪 검증 단계: 단위 테스트 및 완료 기준

### 5. 단위 테스트 구현 (Test Layer)

- **`PopupPolicyManagerTest.kt`** 파일을 생성하고 다음 객체들을 **가짜(Mockk)**로 설정할 것:
    - `UpdatePolicyRepository` (가짜 정책 데이터를 반환)
    - `SharedPreferences` (가짜 로컬 기록을 반환)
- 다음 3가지 핵심 시나리오를 검증하는 @Test 함수를 구현할 것:
    
    a) 강제 업데이트 테스트: is_force_update=true인 가짜 데이터를 주입했을 때, 다른 조건과 상관없이 노출이 허가되는지 검증.
    
    b) 횟수 초과 테스트: '나중에 보기' 횟수가 초과되었을 때 (currentLaterCount > max_later_count), 노출이 금지되는지 검증.
    
    c) 쿨다운 테스트: 팝업이 닫힌 후 reshow_interval_hours가 지나지 않았을 때, 노출이 금지되는지 검증.
    

### 6. 완료 기준

- *`PopupPolicyManagerTest.kt`*의 모든 `@Test` 함수가 성공적으로 실행되었음을 증명하는 **테스트 실행 결과 스크린샷 또는 문서**를 제출할 것.